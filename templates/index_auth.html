<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindSpace - Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: white;
            padding: 0.8rem 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #667eea;
            font-size: 1.6rem;
        }
        
        .header .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn {
            padding: 8px 16px;
            background: #ff6b6b;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: background 0.3s;
        }
        
        .logout-btn:hover {
            background: #ff5252;
        }
        
        .mood-link {
            padding: 8px 16px;
            background: #f8f9fa;
            color: #667eea;
            text-decoration: none;
            border-radius: 6px;
            font-size: 0.9rem;
            border: 1px solid #667eea;
            transition: all 0.3s;
        }
        
        .mood-link:hover {
            background: #667eea;
            color: white;
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            padding: 0.5rem;
            gap: 0.5rem;
        }
        
        .chat-history {
            overflow-y: auto;
            padding: 0.5rem 0;
            max-height: 60vh;
        }
        
        .message {
            margin-bottom: 1.5rem;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .user-message {
            background: #667eea;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 20px 20px 5px 20px;
            margin-left: auto;
            max-width: 70%;
            margin-bottom: 0.5rem;
        }
        
        .assistant-message {
            background: white;
            padding: 1.5rem;
            border-radius: 20px 20px 20px 5px;
            max-width: 85%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            line-height: 1.6;
        }
        
        .assistant-message h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: #888;
            margin-top: 0.5rem;
        }
        
        .input-container {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .input-form {
            display: flex;
            gap: 0.8rem;
            align-items: flex-end;
        }
        
        .message-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 1rem;
            resize: vertical;
            min-height: 45px;
            max-height: 100px;
            font-family: inherit;
        }
        
        .message-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .send-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
        }
        
        .quick-actions {
            margin-top: 0.8rem;
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 6px 12px;
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 16px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }
        
        .quick-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        /* Smart Suggestions */
        .smart-suggestions {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin: 0.5rem 0;
        }
        
        .smart-suggestions h4 {
            color: #667eea;
            margin-bottom: 0.8rem;
            font-size: 1rem;
        }
        
        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
        }
        
        .suggestion-btn {
            background: #f0f2ff;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .suggestion-btn:hover {
            background: #667eea;
            color: white;
        }
        
        /* Meditation Timer Styles */
        .meditation-timer {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 20px;
            margin: 1rem 0;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
        
        .timer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .timer-header h3 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .close-timer-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-timer-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .timer-options {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }
        
        .timer-option-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .timer-option-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .custom-timer {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }
        
        .custom-timer input {
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            width: 120px;
            text-align: center;
        }
        
        .custom-timer-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
        }
        
        .music-selection {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 1px solid rgba(255,255,255,0.2);
        }
        
        .music-selection h4 {
            margin-bottom: 1rem;
            font-size: 1.1rem;
        }
        
        .music-options {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        
        .music-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 2px solid rgba(255,255,255,0.2);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .music-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .music-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }
        
        .test-audio {
            margin: 1rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        
        .test-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .test-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        #audioStatus {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .volume-control label {
            font-size: 0.9rem;
        }
        
        .volume-control input[type="range"] {
            width: 120px;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.2);
            outline: none;
        }
        
        .volume-control input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
        }
        
        .volume-control input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
        }
        
        #volumeDisplay {
            font-size: 0.9rem;
            min-width: 35px;
        }
        
        .breathing-circle {
            width: 150px;
            height: 150px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            margin: 2rem auto;
            background: rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 4s ease-in-out;
        }
        
        .breathing-circle.inhale {
            transform: scale(1.3);
        }
        
        .breathing-circle.exhale {
            transform: scale(1);
        }
        
        .timer-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 1rem 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .timer-phase {
            font-size: 1.2rem;
            margin: 1rem 0;
            opacity: 0.9;
        }
        
        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }
        
        .control-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .stop-btn:hover {
            background: rgba(255,100,100,0.3);
        }
        
        .completion-message h3 {
            font-size: 2rem;
            margin-bottom: 1rem;
        }
        
        .completion-message p {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }
        
        .complete-btn, .restart-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            margin: 0 0.5rem;
            transition: all 0.3s;
        }
        
        .complete-btn:hover, .restart-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Daily Tip Styles */
        .daily-tip {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.6rem;
            border-radius: 10px;
            text-align: center;
            font-style: italic;
            font-size: 0.95rem;
        }
        
        /* Mood Tracker Styles */
        .mood-tracker {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            margin: 1rem 0;
        }
        
        .mood-tracker h3 {
            color: #667eea;
            margin-bottom: 0.8rem;
            font-size: 1.1rem;
        }
        
        .mood-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .mood-options {
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        
        .mood-btn {
            background: none;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            padding: 15px 20px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .mood-btn:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }
        
        .mood-btn.selected {
            border-color: #667eea;
            background: #f0f2ff;
            transform: scale(1.1);
        }
        
        .submit-mood-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 1rem;
        }
        
        .cancel-mood-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #e0e0e0;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 1rem;
            margin-left: 1rem;
        }
        
        .cancel-mood-btn:hover {
            background: #e0e0e0;
        }
        
        .mood-notes {
            padding: 10px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        
        .mood-history-link {
            color: #667eea;
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            display: inline-block;
        }
        
        /* Self-Care Plan Offer */
        .self-care-offer {
            background: #f8f9fa;
            border: 2px solid #667eea;
            padding: 1rem;
            border-radius: 15px;
            text-align: center;
        }
        
        .self-care-offer h3 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .plan-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 0.5rem;
            transition: transform 0.2s;
        }
        
        .plan-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Response Suggestions */
        .response-suggestions {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }
        
        .suggestion-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .suggestion-btn {
            background: #f0f2ff;
            color: #667eea;
            border: 1px solid #667eea;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .suggestion-btn:hover {
            background: #667eea;
            color: white;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üßò‚Äç‚ôÄÔ∏è MindSpace</h1>
        <div class="user-info">
            <span>Welcome back!</span>
            <a href="{{ url_for('mood_history') }}" class="mood-link">üìä Mood History</a>
            <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
        </div>
        
        <!-- Hidden Mood Tracker (shows when needed) -->
        <div class="mood-tracker" id="moodTracker" style="display: none;">
            <h3>How are you feeling right now?</h3>
            <form method="POST" class="mood-form" id="moodForm">
                <div class="mood-options">
                    <button type="button" class="mood-btn" onclick="selectMood(1, 'üòû')">üòû</button>
                    <button type="button" class="mood-btn" onclick="selectMood(2, 'üòê')">üòê</button>
                    <button type="button" class="mood-btn" onclick="selectMood(3, 'üôÇ')">üôÇ</button>
                    <button type="button" class="mood-btn" onclick="selectMood(4, 'üòÉ')">üòÉ</button>
                </div>
                <input type="hidden" name="mood_score" id="moodScore" value="">
                <input type="text" name="mood_notes" placeholder="Optional: Add a note about your mood..." class="mood-notes">
                <button type="button" onclick="hideMoodTracker()" class="cancel-mood-btn">Cancel</button>
            </form>
        </div>
    </div>
    
    <div class="chat-container">
        <!-- Daily Tip Section -->
        <div class="daily-tip">
            <p>{{ daily_tip }}</p>
        </div>
        
        <div class="chat-history">
            {% for chat in chat_history %}
            <div class="message">
                <div class="user-message">
                    {{ chat.message }}
                </div>
                <div class="assistant-message">
                    <h3>üåü MindSpace Assistant</h3>
                    {{ chat.response }}
                    <div class="timestamp">{{ chat.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <!-- Smart Suggestions (only show if there are messages) -->
        {% if chat_history %}
        <div class="smart-suggestions">
            <h4>üí° What would you like to try next?</h4>
            <div class="suggestion-buttons">
                <button class="suggestion-btn" onclick="fillMessage('Guide me through a 5-minute meditation')">5-Minute Meditation</button>
                <button class="suggestion-btn" onclick="fillMessage('Teach me box breathing')">Box Breathing</button>
                <button class="suggestion-btn" onclick="fillMessage('Show me grounding techniques')">Grounding Techniques</button>
                <button class="suggestion-btn" onclick="fillMessage('I need stress relief techniques')">Stress Relief</button>
                <button class="suggestion-btn" onclick="showMeditationTimer()">üßò‚Äç‚ôÄÔ∏è Meditation Timer</button>
            </div>
        </div>
        {% endif %}
        
        <!-- Meditation Timer (Hidden by default) -->
        <div class="meditation-timer" id="meditationTimer" style="display: none;">
            <div class="timer-header">
                <h3>üßò‚Äç‚ôÄÔ∏è Meditation Timer</h3>
                <button onclick="closeMeditationTimer()" class="close-timer-btn">√ó</button>
            </div>
            
            <div class="timer-setup" id="timerSetup">
                <h4>Choose your session length:</h4>
                <div class="timer-options">
                    <button class="timer-option-btn" onclick="startMeditation(3)">3 min</button>
                    <button class="timer-option-btn" onclick="startMeditation(5)">5 min</button>
                    <button class="timer-option-btn" onclick="startMeditation(10)">10 min</button>
                    <button class="timer-option-btn" onclick="startMeditation(15)">15 min</button>
                    <button class="timer-option-btn" onclick="startMeditation(20)">20 min</button>
                </div>
                <div class="custom-timer">
                    <input type="number" id="customMinutes" placeholder="Custom minutes" min="1" max="60">
                    <button onclick="startCustomMeditation()" class="custom-timer-btn">Start</button>
                </div>
                
                <div class="music-selection">
                    <h4>Choose background sounds:</h4>
                    <div class="music-options">
                        <button class="music-btn" onclick="selectMusic('none')" id="music-none">üîá Silent</button>
                        <button class="music-btn active" onclick="selectMusic('rain')" id="music-rain">üåßÔ∏è Rain</button>
                        <button class="music-btn" onclick="selectMusic('ocean')" id="music-ocean">üåä Ocean</button>
                        <button class="music-btn" onclick="selectMusic('forest')" id="music-forest">üå≤ Forest</button>
                        <button class="music-btn" onclick="selectMusic('singing-bowls')" id="music-singing-bowls">üéµ Singing Bowls</button>
                    </div>
                    <div class="test-audio">
                        <button onclick="testAudio()" class="test-btn" id="testBtn">üîä Test Sound</button>
                        <span id="audioStatus">Click to test audio</span>
                    </div>
                    <div class="volume-control">
                        <label for="volumeSlider">Volume:</label>
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" oninput="adjustVolume(this.value)">
                        <span id="volumeDisplay">50%</span>
                    </div>
                </div>
            </div>
            
            <div class="timer-active" id="timerActive" style="display: none;">
                <div class="breathing-circle" id="breathingCircle"></div>
                <div class="timer-display" id="timerDisplay">5:00</div>
                <div class="timer-phase" id="timerPhase">Get ready to begin...</div>
                <div class="timer-controls">
                    <button onclick="pauseTimer()" id="pauseBtn" class="control-btn">‚è∏Ô∏è Pause</button>
                    <button onclick="toggleMusic()" id="musicBtn" class="control-btn">üîä Music</button>
                    <button onclick="stopTimer()" class="control-btn stop-btn">‚èπÔ∏è Stop</button>
                </div>
            </div>
            
            <!-- Audio Elements with reliable open-source sounds -->
            <audio id="rainSound" loop preload="none" crossorigin="anonymous">
                <source src="https://freesound.org/data/previews/316/316847_5259123-hq.mp3" type="audio/mpeg">
                <source src="https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3" type="audio/mpeg">
            </audio>
            <audio id="oceanSound" loop preload="none" crossorigin="anonymous">
                <source src="https://freesound.org/data/previews/393/393651_7037-hq.mp3" type="audio/mpeg">
                <source src="https://cdn.pixabay.com/download/audio/2021/08/09/audio_bb630cc098.mp3" type="audio/mpeg">
            </audio>
            <audio id="forestSound" loop preload="none" crossorigin="anonymous">
                <source src="https://freesound.org/data/previews/427/427567_8462944-hq.mp3" type="audio/mpeg">
                <source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_4037cd5cbf.mp3" type="audio/mpeg">
            </audio>
            <audio id="singing-bowlsSound" loop preload="none" crossorigin="anonymous">
                <source src="https://freesound.org/data/previews/316/316738_5260872-hq.mp3" type="audio/mpeg">
                <source src="https://cdn.pixabay.com/download/audio/2021/11/21/audio_5d2a6c15d9.mp3" type="audio/mpeg">
            </audio>
            
            <!-- Test tone that works -->
            <audio id="testTone" preload="none">
                <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmYeBUCS1O/PgCwFJ3i+7t2VRw4PVq3j66pXGAg9k9n1unobBzuOze2ykCoDI2+z4N2ZSQoMVq7o66hVFgpGn9T3vGYdBjJ+yOzfmkQHFGql5tSgWBkINn7M7dWSQw0OVqns5qlZGQc8k9r2unscBjuLze7akiIFF2yu59mhXBoGOIzY9blsGgY6jdXyuWwaBjiK2fS7bBsHOozT+LptHgU2jdBvPAAAAAA=" type="audio/wav">
            </audio>
            
            <div class="timer-complete" id="timerComplete" style="display: none;">
                <div class="completion-message">
                    <h3>üåü Well done!</h3>
                    <p>You've completed your meditation session. Take a moment to notice how you feel.</p>
                    <button onclick="closeMeditationTimer()" class="complete-btn">Continue</button>
                    <button onclick="showTimerSetup()" class="restart-btn">Meditate Again</button>
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <form method="POST" class="input-form">
                <textarea name="message" class="message-input" placeholder="Share what's on your mind, ask for meditation techniques, or let me know how you're feeling..." required></textarea>
                <button type="submit" class="send-btn">Send</button>
            </form>
            
            <div class="quick-actions">
                <button class="quick-btn" onclick="fillMessage(`I'm feeling anxious today`)">Feeling Anxious</button>
                <button class="quick-btn" onclick="fillMessage(`Guide me through a 5-minute meditation`)">5-Minute Meditation</button>
                <button class="quick-btn" onclick="fillMessage(`Teach me box breathing`)">Box Breathing</button>
                <button class="quick-btn" onclick="fillMessage(`I'm having trouble sleeping`)">Sleep Help</button>
                <button class="quick-btn" onclick="fillMessage(`Show me grounding techniques`)">Grounding Techniques</button>
                <button class="quick-btn" onclick="fillMessage(`I need stress relief techniques`)">Stress Relief</button>
                <button class="quick-btn" onclick="fillMessage(`Teach me progressive muscle relaxation`)">Muscle Relaxation</button>
                <button class="quick-btn" onclick="fillMessage(`Guide me through mindful breathing`)">Mindful Breathing</button>
            </div>
        </div>
    </div>
    
    <script>
        function fillMessage(text) {
            document.querySelector('.message-input').value = text;
            document.querySelector('.message-input').focus();
        }
        
        function showMoodTracker() {
            document.getElementById('moodTracker').style.display = 'block';
            document.getElementById('moodTracker').scrollIntoView({ behavior: 'smooth' });
        }
        
        function hideMoodTracker() {
            document.getElementById('moodTracker').style.display = 'none';
        }
        
        // Meditation Timer Functions
        let meditationInterval;
        let timeRemaining;
        let isPaused = false;
        let breathingInterval;
        let currentMusic = 'rain';
        let musicPlaying = false;
        let currentAudio = null;
        
        function selectMusic(musicType) {
            // Remove active class from all buttons
            document.querySelectorAll('.music-btn').forEach(btn => btn.classList.remove('active'));
            // Add active class to selected button
            document.getElementById(`music-${musicType}`).classList.add('active');
            currentMusic = musicType;
        }
        
        function adjustVolume(value) {
            document.getElementById('volumeDisplay').textContent = value + '%';
            // If music is playing, update the volume immediately
            if (musicPlaying && audioContext) {
                updateAudioVolume(value / 100);
            }
        }
        
        function updateAudioVolume(volume) {
            // This will be implemented per sound type
            if (currentMasterGain) {
                currentMasterGain.gain.value = volume * 0.3;
            }
        }
        
        function adjustVolume(value) {
            document.getElementById('volumeDisplay').textContent = value + '%';
            // If music is playing, update the volume immediately
            if (musicPlaying) {
                updateAudioVolume(value / 100);
            }
        }
        
        function testMusicFiles() {
            const statusElement = document.getElementById('audioStatus');
            const testBtn = document.getElementById('testMusicBtn');
            
            statusElement.textContent = 'Testing music files...';
            testBtn.textContent = 'üîÑ Testing...';
            
            // Test each audio file
            const sounds = ['rain', 'ocean', 'forest', 'singing-bowls'];
            let workingCount = 0;
            let testedCount = 0;
            
            sounds.forEach(sound => {
                const audio = document.getElementById(sound + 'Sound');
                if (audio) {
                    audio.addEventListener('canplaythrough', function testHandler() {
                        workingCount++;
                        testedCount++;
                        updateTestStatus();
                        audio.removeEventListener('canplaythrough', testHandler);
                    });
                    
                    audio.addEventListener('error', function errorHandler() {
                        testedCount++;
                        updateTestStatus();
                        audio.removeEventListener('error', errorHandler);
                    });
                    
                    // Try to load the audio
                    audio.load();
                }
            });
            
            function updateTestStatus() {
                if (testedCount === sounds.length) {
                    if (workingCount > 0) {
                        statusElement.textContent = `${workingCount}/${sounds.length} music files working ‚úÖ`;
                        testBtn.textContent = 'üéµ Files OK';
                    } else {
                        statusElement.textContent = 'No music files working, will use generated sounds';
                        testBtn.textContent = '‚ùå Files Failed';
                    }
                    
                    setTimeout(() => {
                        testBtn.textContent = 'üéµ Test Music Files';
                        statusElement.textContent = 'Ready to play';
                    }, 3000);
                }
            }
            
            // Timeout in case some files never respond
            setTimeout(() => {
                if (testedCount < sounds.length) {
                    statusElement.textContent = 'Some music files timed out, using fallbacks';
                    testBtn.textContent = '‚ö†Ô∏è Mixed Results';
                }
            }, 10000);
        }
        
        function testAudio() {
            const statusElement = document.getElementById('audioStatus');
            const testBtn = document.getElementById('testBtn');
            
            try {
                initAudioContext();
                
                // Create a simple beep to test audio
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 note
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.1);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.5);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
                statusElement.textContent = 'Audio working! ‚úÖ';
                testBtn.textContent = 'üîä Test Passed!';
                
                setTimeout(() => {
                    testBtn.textContent = 'üîä Test Sound';
                    statusElement.textContent = 'Audio ready';
                }, 2000);
                
            } catch (error) {
                console.error('Audio test failed:', error);
                statusElement.textContent = 'Audio blocked/failed ‚ùå';
                testBtn.textContent = '‚ùå Audio Issue';
            }
        }
        
        function playMeditationMusic() {
            if (currentMusic === 'none') return;
            
            // Stop any currently playing audio
            stopMeditationMusic();
            
            // Start new audio based on selection
            try {
                if (currentMusic === 'rain') {
                    generateRainSound();
                } else if (currentMusic === 'ocean') {
                    generateOceanSound();
                } else if (currentMusic === 'forest') {
                    generateForestSound();
                } else if (currentMusic === 'singing-bowls') {
                    generateSingingBowlsSound();
                }
                
                musicPlaying = true;
                updateMusicButton();
            } catch (error) {
                console.log('Audio not supported or blocked by browser');
                musicPlaying = false;
                updateMusicButton();
            }
        }
        
        function stopMeditationMusic() {
            stopAllAudio();
            musicPlaying = false;
            updateMusicButton();
        }
        
        function toggleMusic() {
            if (musicPlaying) {
                stopMeditationMusic();
            } else {
                playMeditationMusic();
            }
        }
        
        function updateMusicButton() {
            const musicBtn = document.getElementById('musicBtn');
            if (musicBtn) {
                musicBtn.textContent = musicPlaying ? 'üîá Mute' : 'üîä Music';
            }
        }
        
        // Simple sound generators for demo (in a real app, use actual audio files)
        let audioContext;
        let audioNodes = [];
        let currentMasterGain = null;
        
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            // Resume audio context if it's suspended (required by browser policies)
            if (audioContext.state === 'suspended') {
                return audioContext.resume();
            }
            return Promise.resolve();
        }
        
        function stopAllAudio() {
            audioNodes.forEach(node => {
                try {
                    if (node.stop) {
                        node.stop();
                    } else if (node.disconnect) {
                        node.disconnect();
                    }
                } catch (e) {
                    // Node might already be stopped
                }
            });
            audioNodes = [];
            currentMasterGain = null;
        }
        
        function generateRainSound() {
            initAudioContext().then(() => {
                stopAllAudio();
                
                currentMasterGain = audioContext.createGain();
                const volume = document.getElementById('volumeSlider').value / 100;
                currentMasterGain.gain.value = volume * 0.4; // More reasonable volume
                
                // Create gentle rain sound with filtered white noise
                const bufferSize = 8192;
                const buffer = audioContext.createBuffer(2, bufferSize, audioContext.sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const output = buffer.getChannelData(channel);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * 0.3; // Softer noise
                    }
                }
                
                const rainNoise = audioContext.createBufferSource();
                rainNoise.buffer = buffer;
                rainNoise.loop = true;
                
                // Filter to make it sound like gentle rain
                const highpass = audioContext.createBiquadFilter();
                highpass.type = 'highpass';
                highpass.frequency.value = 800; // Remove low rumble
                
                const lowpass = audioContext.createBiquadFilter();
                lowpass.type = 'lowpass';
                lowpass.frequency.value = 4000; // Keep the pleasant frequencies
                
                // Gentle modulation for natural variation
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();
                lfo.type = 'sine';
                lfo.frequency.setValueAtTime(0.2, audioContext.currentTime);
                lfoGain.gain.value = 0.1;
                
                lfo.connect(lfoGain);
                lfoGain.connect(currentMasterGain.gain);
                
                rainNoise.connect(highpass);
                highpass.connect(lowpass);
                lowpass.connect(currentMasterGain);
                currentMasterGain.connect(audioContext.destination);
                
                rainNoise.start();
                lfo.start();
                
                audioNodes.push(rainNoise, lfo);
                document.getElementById('audioStatus').textContent = 'Playing gentle rain üåßÔ∏è';
            }).catch(e => {
                document.getElementById('audioStatus').textContent = 'Audio failed to start';
            });
        }
        
        function generateOceanSound() {
            initAudioContext().then(() => {
                stopAllAudio();
                
                currentMasterGain = audioContext.createGain();
                const volume = document.getElementById('volumeSlider').value / 100;
                currentMasterGain.gain.value = volume * 0.6;
                
                // Create realistic ocean waves by combining:
                // 1. Filtered white noise for wave crashes
                // 2. Low frequency sine waves for wave rhythm
                // 3. Modulation for natural wave movement
                
                // White noise for wave crashes/foam
                const bufferSize = 16384;
                const buffer = audioContext.createBuffer(2, bufferSize, audioContext.sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const output = buffer.getChannelData(channel);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * 0.5;
                    }
                }
                
                const whiteNoise = audioContext.createBufferSource();
                whiteNoise.buffer = buffer;
                whiteNoise.loop = true;
                
                // Filter the noise to sound like waves
                const highpass = audioContext.createBiquadFilter();
                highpass.type = 'highpass';
                highpass.frequency.value = 100;
                
                const lowpass = audioContext.createBiquadFilter();
                lowpass.type = 'lowpass';
                lowpass.frequency.value = 1200;
                
                const waveGain = audioContext.createGain();
                waveGain.gain.value = 0.4;
                
                // Create wave rhythm with low frequency oscillator
                const waveRhythm = audioContext.createOscillator();
                const rhythmGain = audioContext.createGain();
                waveRhythm.type = 'sine';
                waveRhythm.frequency.setValueAtTime(0.1, audioContext.currentTime); // Very slow wave rhythm
                rhythmGain.gain.value = 0.3;
                
                // Connect the wave rhythm to modulate the wave gain
                waveRhythm.connect(rhythmGain);
                rhythmGain.connect(waveGain.gain);
                
                // Base ocean rumble
                const baseOsc = audioContext.createOscillator();
                const baseGain = audioContext.createGain();
                baseOsc.type = 'sine';
                baseOsc.frequency.setValueAtTime(60, audioContext.currentTime);
                baseGain.gain.value = 0.3;
                
                // Modulate the base frequency slightly for natural variation
                const baseLfo = audioContext.createOscillator();
                const baseLfoGain = audioContext.createGain();
                baseLfo.type = 'sine';
                baseLfo.frequency.setValueAtTime(0.05, audioContext.currentTime);
                baseLfoGain.gain.value = 10;
                
                baseLfo.connect(baseLfoGain);
                baseLfoGain.connect(baseOsc.frequency);
                
                // Connect everything together
                whiteNoise.connect(highpass);
                highpass.connect(lowpass);
                lowpass.connect(waveGain);
                waveGain.connect(currentMasterGain);
                
                baseOsc.connect(baseGain);
                baseGain.connect(currentMasterGain);
                
                currentMasterGain.connect(audioContext.destination);
                
                // Start all oscillators
                whiteNoise.start();
                waveRhythm.start();
                baseOsc.start();
                baseLfo.start();
                
                audioNodes.push(whiteNoise, waveRhythm, baseOsc, baseLfo);
                document.getElementById('audioStatus').textContent = 'Playing ocean waves üåä';
            });
        }
        
        function generateForestSound() {
            initAudioContext().then(() => {
                stopAllAudio();
                
                currentMasterGain = audioContext.createGain();
                const volume = document.getElementById('volumeSlider').value / 100;
                currentMasterGain.gain.value = volume * 0.6; // Louder
                
                // Create gentle wind-like forest ambiance
                const bufferSize = 8192;
                const buffer = audioContext.createBuffer(2, bufferSize, audioContext.sampleRate);
                
                for (let channel = 0; channel < 2; channel++) {
                    const output = buffer.getChannelData(channel);
                    for (let i = 0; i < bufferSize; i++) {
                        output[i] = (Math.random() * 2 - 1) * 0.2;
                    }
                }
                
                const forestNoise = audioContext.createBufferSource();
                forestNoise.buffer = buffer;
                forestNoise.loop = true;
                
                // Filter for gentle wind through trees
                const filter = audioContext.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 400;
                filter.Q.value = 2;
                
                // Add some gentle modulation
                const lfo = audioContext.createOscillator();
                const lfoGain = audioContext.createGain();
                lfo.type = 'sine';
                lfo.frequency.setValueAtTime(0.1, audioContext.currentTime);
                lfoGain.gain.value = 50;
                
                lfo.connect(lfoGain);
                lfoGain.connect(filter.frequency);
                
                forestNoise.connect(filter);
                filter.connect(currentMasterGain);
                currentMasterGain.connect(audioContext.destination);
                
                forestNoise.start();
                lfo.start();
                
                audioNodes.push(forestNoise, lfo);
                document.getElementById('audioStatus').textContent = 'Playing forest sounds üå≤';
            });
        }
        
        function generateSingingBowlsSound() {
            initAudioContext().then(() => {
                stopAllAudio();
                
                currentMasterGain = audioContext.createGain();
                const volume = document.getElementById('volumeSlider').value / 100;
                currentMasterGain.gain.value = volume * 0.5; // Louder
                
                // Create more prominent singing bowl tones
                const fundamentalFreqs = [174, 285, 396, 528]; // Healing frequencies
                
                fundamentalFreqs.forEach((freq, index) => {
                    const oscillator = audioContext.createOscillator();
                    const harmonic = audioContext.createGain();
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    
                    // More audible volumes with gentle fade-in
                    harmonic.gain.setValueAtTime(0, audioContext.currentTime);
                    harmonic.gain.linearRampToValueAtTime(0.3 / (index + 1), audioContext.currentTime + 3);
                    
                    // Add subtle vibrato for more organic sound
                    const vibrato = audioContext.createOscillator();
                    const vibratoGain = audioContext.createGain();
                    vibrato.type = 'sine';
                    vibrato.frequency.setValueAtTime(2, audioContext.currentTime);
                    vibratoGain.gain.value = 2;
                    
                    vibrato.connect(vibratoGain);
                    vibratoGain.connect(oscillator.frequency);
                    
                    oscillator.connect(harmonic);
                    harmonic.connect(currentMasterGain);
                    
                    oscillator.start();
                    vibrato.start();
                    audioNodes.push(oscillator, vibrato);
                });
                
                currentMasterGain.connect(audioContext.destination);
                document.getElementById('audioStatus').textContent = 'Playing singing bowls üéµ';
            });
        }
        
        function showMeditationTimer() {
            document.getElementById('meditationTimer').style.display = 'block';
            document.getElementById('meditationTimer').scrollIntoView({ behavior: 'smooth' });
        }
        
        function closeMeditationTimer() {
            document.getElementById('meditationTimer').style.display = 'none';
            stopTimer();
        }
        
        function startMeditation(minutes) {
            timeRemaining = minutes * 60;
            document.getElementById('timerSetup').style.display = 'none';
            document.getElementById('timerActive').style.display = 'block';
            document.getElementById('timerComplete').style.display = 'none';
            
            updateTimerDisplay();
            startBreathingAnimation();
            
            meditationInterval = setInterval(() => {
                if (!isPaused) {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        completeMeditation();
                    }
                }
            }, 1000);
        }
        
        function startCustomMeditation() {
            const customMinutes = document.getElementById('customMinutes').value;
            if (customMinutes && customMinutes > 0 && customMinutes <= 60) {
                startMeditation(parseInt(customMinutes));
            } else {
                alert('Please enter a valid number between 1 and 60 minutes.');
            }
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
            // Update breathing phase
            const breathPhase = Math.floor(timeRemaining / 4) % 2;
            const phaseText = breathPhase === 0 ? 'Breathe in slowly...' : 'Breathe out gently...';
            document.getElementById('timerPhase').textContent = phaseText;
        }
        
        function startBreathingAnimation() {
            const circle = document.getElementById('breathingCircle');
            let isInhaling = true;
            
            breathingInterval = setInterval(() => {
                if (!isPaused) {
                    if (isInhaling) {
                        circle.className = 'breathing-circle inhale';
                        document.getElementById('timerPhase').textContent = 'Breathe in slowly...';
                    } else {
                        circle.className = 'breathing-circle exhale';
                        document.getElementById('timerPhase').textContent = 'Breathe out gently...';
                    }
                    isInhaling = !isInhaling;
                }
            }, 4000); // 4 second breathing cycle
        }
        
        function pauseTimer() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = isPaused ? '‚ñ∂Ô∏è Resume' : '‚è∏Ô∏è Pause';
        }
        
        function stopTimer() {
            clearInterval(meditationInterval);
            clearInterval(breathingInterval);
            showTimerSetup();
        }
        
        function completeMeditation() {
            clearInterval(meditationInterval);
            clearInterval(breathingInterval);
            document.getElementById('timerActive').style.display = 'none';
            document.getElementById('timerComplete').style.display = 'block';
            
            // Play a gentle completion sound (optional)
            // You could add audio here if desired
        }
        
        function showTimerSetup() {
            document.getElementById('timerSetup').style.display = 'block';
            document.getElementById('timerActive').style.display = 'none';
            document.getElementById('timerComplete').style.display = 'none';
            isPaused = false;
            document.getElementById('pauseBtn').textContent = '‚è∏Ô∏è Pause';
            document.getElementById('customMinutes').value = '';
        }
        
        function selectMood(score, emoji) {
            // Remove selected class from all mood buttons
            document.querySelectorAll('.mood-btn').forEach(btn => btn.classList.remove('selected'));
            
            // Add selected class to clicked button
            event.target.classList.add('selected');
            
            // Set hidden input value
            document.getElementById('moodScore').value = score;
            
            // Show brief confirmation
            const moodTracker = document.querySelector('#moodTracker h3');
            const originalText = moodTracker.textContent;
            moodTracker.textContent = `${emoji} Mood logged! Thank you.`;
            moodTracker.style.color = '#28a745';
            
            // Submit form after showing confirmation
            setTimeout(() => {
                document.getElementById('moodForm').submit();
            }, 1500);
        }
        
        // Auto-scroll to bottom of chat
        const chatHistory = document.querySelector('.chat-history');
        if (chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // Auto-resize textarea
        const textarea = document.querySelector('.message-input');
        if (textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = this.scrollHeight + 'px';
            });
        }
    </script>
</body>
</html>